version: '3.7'

networks:
  frontend:
  backend:

services:

# -----------------------------------------------------------------
# Reverse Proxy

  traefik:
    image: traefik:v2.6
    container_name: "traefik"
    restart: unless-stopped

    networks:
      - frontend
      - backend

    ports:
      - 80:80
      - 443:443
      
    volumes:
      # Traefik can listen to the Docker events
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Define Time
      - /etc/localtime:/etc/localtime:ro

       # Configuration      
      - ./devops/traefik/traefik.toml:/etc/traefik/traefik.toml:ro
      - ./devops/traefik/traefik_dynamic.toml:/etc/traefik/traefik_dynamic.toml:ro

      # Data Storage 
      - ./data/traefik/acme.json:/acme.json


# -----------------------------------------------------------------
# Mosquitto
# mqtt.bee.espertamente.com.br

  mosquitto:
    image: eclipse-mosquitto:latest
    restart: always
    container_name: "mosquitto"

    networks:
      - backend

    ports:
      - 1883:1883

    volumes:
      # Configuration
      - ./devops/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./devops/mosquitto/mosquitto.passwd:/mosquitto/config/mosquitto.passwd:ro

      # Data Storage
      - ./data/mosquitto/data:/mosquitto/data

      # Log Storage
      - ./data/mosquitto/log:/mosquitto/log


# -----------------------------------------------------------------
# InfluxDB
# influxdb.bee.espertamente.com.br

  influxdb:
    image: influxdb:latest
    container_name: "influxdb"
    restart: always

    networks:
      - frontend
      - backend

    ports:
      - 8086:8086
    
    environment: 
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=espertamente
      - DOCKER_INFLUXDB_INIT_PASSWORD=Iy03yxMzFrahYBv2TBIn
      - DOCKER_INFLUXDB_INIT_ORG=espertamente
      - DOCKER_INFLUXDB_INIT_BUCKET=bee
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=WCHiXnonzowflQRsO7QM

    volumes:
      # Configuration
      # - ./devops/influxdb:/etc/influxdb2
      # Data Storage 
      - ./data/influxdb:/var/lib/influxdb2

    labels:
      - "traefik.enable=true"

      - "traefik.http.routers.influxdb.rule=Host(`influxdb.bee.espertamente.com.br`)"
      - "traefik.http.routers.influxdb.entrypoints=websecure"

      - "traefik.http.services.influxdb.loadbalancer.server.port=8086"
      
      - "traefik.http.routers.influxdb.service=influxdb"
      - "traefik.http.routers.influxdb.tls.certresolver=letsencrypt"


# -----------------------------------------------------------------
# Telegraf


 telegraf:
    image: telegraf:latest
    container_name: "telegraf"
    restart: always

    networks:
      - backend

    #ports:
    #  - 8125:8125
    
    volumes:
      # Configuration
      #- ./devops/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro

    depends_on:
      - influxdb
    links:
      - influxdb

    environment: 
      - DOCKER_INFLUXDB_INIT_ORG=espertamente
      - DOCKER_INFLUXDB_INIT_BUCKET=bee
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=WCHiXnonzowflQRsO7QM


# -----------------------------------------------------------------
# Grafana
# grafana.bee.espertamente.com.br

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped

    networks:
      - frontend
      - backend

    user: root:root
    
    ports:
      - 3000:3000

    depends_on:
      - influxdb

    volumes:
      # Define Time
      #- /etc/localtime:/etc/localtime:ro

      # Configuration
      # - ./devops/grafana:/etc/grafana

      # Data Storage
      - ./data/grafana:/var/lib/grafana

      # Log Storage
      # - ./logs/grafana/:/var/log/grafana
      
    environment:
      - GF_SECURITY_ADMIN_USER=espertamente
      - GF_SECURITY_ADMIN_PASSWORD=MuitoObrigado!!!MuitoObrigado!!!MuitoObrigado!!!
      - GF_USERS_ALLOW_SIGN_UP=false
      # - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource

    labels:
      - "traefik.enable=true"

      - "traefik.http.routers.grafana.rule=Host(`grafana.bee.espertamente.com.br`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"

      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
      
      - "traefik.http.routers.grafana.service=grafana"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"


# -----------------------------------------------------------------
# NodeRED
# nodered.bee.espertamente.com.br

  nodered:
    image: nodered/node-red:latest
    restart: unless-stopped
    container_name: nodered

    networks:
      - frontend
      - backend

    user: root:root
    
    environment:
      - TZ=America/Sao_Paulo
      # - NODE_RED_ENABLE_PROJECTS=true
      # - NODE_RED_CREDENTIAL_SECRET=$apr1$GCd5TkKn$PZvSTWH7UkvkszmYSaNUI/
    
    volumes:
      # Define Time
      - /etc/localtime:/etc/localtime:ro

      # Configuration
      - ./devops/nodered/settings.js:/data/settings.js
      - ./devops/nodered/public_html:/data/public_html

      # data Storage
      - ./data/nodered:/data

    labels:
      - "traefik.enable=true"

      - "traefik.http.routers.nodered.rule=Host(`nodered.bee.espertamente.com.br`)"
      - "traefik.http.routers.nodered.entrypoints=websecure"

      - "traefik.http.services.nodered.loadbalancer.server.port=1880"
      
      - "traefik.http.routers.nodered.service=nodered"
      - "traefik.http.routers.nodered.tls.certresolver=letsencrypt"